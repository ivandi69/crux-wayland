# Description: Mesa 3D Graphics Library
# URL:         https://www.mesa3d.org/
# Maintainer:  ivandi
# Depends on:  elfutils glslang libdrm llvm meson ninja python3-mako vulkan-loader wayland-protocols lm_sensors 
# Optional     libva libvdpau libglvnd xorg-libxdamage xorg-libxrandr xorg-libxshmfence xorg-libxvmc xorg-libxxf86vm

name=mesa
version=21.1.3
release=1
source=(https://mesa.freedesktop.org/archive/${name}-${version}.tar.xz)

build() {
	if prt-get isinst xorg-libx11 ; then
		PKGMK_MESA_GLX="gri"
		PKGMK_MESA_GLVND="true"
		PKGMK_MESA_PLATFORMS="x11,wayland"
	else
		PKGMK_MESA_GLX="disabled"
		PKGMK_MESA_GLVND="false"
		PKGMK_MESA_PLATFORMS="wayland"
	fi
	cd ${name}-${version}
	meson build \
		--prefix=/usr \
		--sysconfdir=/etc \
		-D buildtype=plain \
		-D b_ndebug=true \
		-D b_lto=false \
		-D llvm=enabled \
		-D shared-llvm=enabled \
		-D shared-glapi=enabled \
		-D gbm=enabled \
		-D gles1=enabled \
		-D gles2=enabled \
		-D dri3=enabled \
		-D egl=enabled \
		-D dri-drivers=i915,i965,r100,r200,nouveau \
		-D osmesa=true \
		-D gallium-drivers=r300,r600,radeonsi,nouveau,virgl,svga,swrast,swr,iris,zink \
		-D vulkan-drivers=amd,intel,swrast \
		-D vulkan-layers=device-select,intel-nullhw,overlay \
		-D swr-arches=avx,avx2 \
		-D lmsensors=enabled \
		-D platforms=$PKGMK_MESA_PLATFORMS \
		-D glx=$PKGMK_MESA_GLX \
		-D glvnd=$PKGMK_MESA_GLVND

	DESTDIR=${PKG} ninja -C build install
}
